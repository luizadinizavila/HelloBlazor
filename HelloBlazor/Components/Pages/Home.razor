@page "/"
@rendermode InteractiveServer
@using HelloBlazor.Components.Services

<PageTitle>Visualizador RTF</PageTitle>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">1. Entrada RTF</div>
                <div class="card-body">
                    <textarea class="form-control mb-2" rows="5"
                              @bind="conteudoRtf"
                              placeholder="Cole o código RTF aqui..."></textarea>

                    <button class="btn btn-success w-100" @onclick="Executar" disabled="@processando">
                        @(processando ? "Processando..." : "PROCESSAR DOCUMENTO")
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white">Logs do Sistema</div>
                <div class="card-body bg-black p-0">
                    <div style="height: 250px; overflow-y: auto; font-family: monospace; font-size: 0.8em; color: #0f0; padding: 10px;">
                        @foreach (var log in resultado.Logs)
                        {
                            <div>@log</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">

            <div class="card mb-3">
                <div class="card-header bg-secondary text-white fw-bold">
                    📄 Visualização do Documento (HTML Convertido)
                </div>
                <div class="card-body" style="min-height: 400px; max-height: 600px; overflow-y: auto; background-color: white;">
                    @if (!string.IsNullOrEmpty(resultado.HtmlConteudo))
                    {
                        @((MarkupString)resultado.HtmlConteudo)
                    }
                    else
                    {
                        <p class="text-muted text-center mt-5">O conteúdo do documento aparecerá aqui.</p>
                    }
                </div>
            </div>

            @if (resultado.ImagensBase64.Count > 0)
            {
                <div class="card">
                    <div class="card-header bg-success text-white">
                        🖼️ Imagens Recuperadas Separadamente (@resultado.ImagensBase64.Count)
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            @foreach (var img in resultado.ImagensBase64)
                            {
                                <div class="col-md-3 text-center mb-3">
                                    <div class="border bg-white p-2 rounded shadow-sm">
                                        <img src="data:image/jpeg;base64,@img" class="img-fluid" style="max-height: 150px;" />
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
</div>

@code {
    private string conteudoRtf { get; set; } = "";
    private bool processando = false;
    private ResultadoExtracao resultado = new ResultadoExtracao();

    private async Task Executar()
    {
        processando = true;
        resultado = new ResultadoExtracao();
        await Task.Delay(50); // Delay visual

        try
        {
            resultado.Logs.Add($"[{DateTime.Now:HH:mm:ss}] Iniciando processamento...");
            var res = Extrator.ProcessarRtf(conteudoRtf);

            resultado.HtmlConteudo = res.HtmlConteudo;
            resultado.ImagensBase64 = res.ImagensBase64;
            resultado.Logs.AddRange(res.Logs);
        }
        catch (Exception ex)
        {
            resultado.Logs.Add($"ERRO: {ex.Message}");
        }

        processando = false;
    }
}