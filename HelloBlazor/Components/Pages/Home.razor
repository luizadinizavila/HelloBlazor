@page "/"
@rendermode InteractiveServer
@using HelloBlazor.Components.Services

<PageTitle>Extrator RTF (Simon Mourier)</PageTitle>

<div class="container mt-4">
    <h2 class="mb-3">Extrator de Imagens OLE (Solução Simon Mourier)</h2>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-bold">Conteúdo RTF (Cole aqui):</label>
                <textarea class="form-control" rows="12"
                          @bind="conteudoRtf"
                          placeholder="Comece com {\rtf1..."></textarea>
                <small class="text-muted">Limite configurado para 64MB.</small>
            </div>

            <button class="btn btn-primary w-100 py-2" @onclick="Executar" disabled="@processando">
                @(processando ? "Processando..." : "EXTRAIR IMAGENS")
            </button>
        </div>

        <div class="col-md-6">
            <label class="form-label fw-bold">Logs do Processamento:</label>
            <div class="bg-dark text-white p-3 rounded shadow-sm"
                 style="height: 380px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85rem;">
                @if (resultado.Logs.Count == 0)
                {
                    <span class="text-secondary">Aguardando início...</span>
                }
                else
                {
                    @foreach (var log in resultado.Logs)
                    {
                        // Estilização simples dos logs
                        var cor = "text-white";
                        if (log.Contains("ERRO") || log.Contains("Falha")) cor = "text-danger fw-bold";
                        else if (log.Contains("SUCESSO")) cor = "text-success fw-bold";
                        else if (log.Contains("-->")) cor = "text-info";

                        <div class="@cor mb-1">@log</div>
                    }
                }
            </div>
        </div>
    </div>

    <hr class="my-5" />

    @if (resultado.ImagensBase64.Count > 0)
    {
        <h3 class="text-success">Imagens Encontradas (@resultado.ImagensBase64.Count):</h3>
        <div class="row">
            @foreach (var imgBase64 in resultado.ImagensBase64)
            {
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow">
                        <div class="card-body text-center d-flex align-items-center justify-content-center bg-light">
                            <img src="data:image/jpeg;base64,@imgBase64"
                                 class="img-fluid"
                                 style="max-height: 250px;" />
                        </div>
                        <div class="card-footer text-muted text-center text-small">
                            Imagem Extraída (OLE Package)
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (resultado.Logs.Count > 0 && !processando)
    {
        <div class="alert alert-warning">
            Nenhuma imagem válida foi extraída. Verifique os logs acima.
        </div>
    }
</div>

@code {
    private string conteudoRtf { get; set; } = "";
    private bool processando = false;
    private ResultadoExtracao resultado = new ResultadoExtracao();

    private async Task Executar()
    {
        processando = true;
        resultado = new ResultadoExtracao(); // Limpa logs anteriores

        // Pequeno delay para a UI atualizar o estado de "Processando"
        await Task.Delay(50);

        resultado.Logs.Add($"[{DateTime.Now:HH:mm:ss}] Botão clicado. Iniciando envio...");

        if (string.IsNullOrWhiteSpace(conteudoRtf))
        {
            resultado.Logs.Add("ERRO: O campo de RTF está vazio!");
            processando = false;
            return;
        }

        // Chama o serviço
        try
        {
            var res = Extrator.ProcessarRtf(conteudoRtf);
            resultado.Logs.AddRange(res.Logs);
            resultado.ImagensBase64 = res.ImagensBase64;
        }
        catch (Exception ex)
        {
            resultado.Logs.Add($"ERRO INESPERADO NA CHAMADA: {ex.Message}");
        }

        processando = false;
    }
}